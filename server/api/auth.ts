import { supabase } from "~/server/utils/supabase";

export default defineEventHandler(async (event) => {
    const body = await readBody(event); // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

    if (!body.id || !body.username) {
        return { error: "–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" };
    }

    //console.log("üì© –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ Telegram:", body);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const { data: existingUser, error } = await supabase
        .from("users")
        .select("*")
        .eq("id", body.id)
        .single();

    if (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error.message);
    }

    if (existingUser) {
        //console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å –≤ –ë–î:", existingUser);
        return { success: true, user: existingUser };
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º
    const { data, error: insertError } = await supabase
        .from("users")
        .insert([
            {
                id: body.id,
                username: body.username,
                first_name: body.first_name,
                last_name: body.last_name || null,
                photo_url: body.photo_url || null,

            },
        ])
        .select()
        .single();

    if (insertError) {
      //  console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î:", insertError.message);
        return { error: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" };
    }

    //console.log("üéâ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ë–î:", data);
    return { success: true, user: data };
});